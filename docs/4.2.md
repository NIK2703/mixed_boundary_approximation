## Подшаг 4.2: Стратегия инициализации параметров оптимизатора — подробный план реализации на C++

### Шаг 4.2.1: Анализ пространства решений и выбор подхода к инициализации

**Классификация доступных стратегий:**
- **Детерминированные методы:** основаны на аналитических или численных решениях упрощённых подзадач
- **Случайные методы:** генерация параметров из вероятностных распределений для исследования пространства решений
- **Гибридные методы:** комбинация детерминированного базового решения с контролируемым случайным возмущением

**Критерии выбора стратегии в зависимости от характеристик задачи:**
- **Плотность данных:** `ρ = N_approx / (b - a)` — отношение числа аппроксимирующих точек к длине интервала
  * `ρ > 5·n` — достаточно данных для надёжной МНК-инициализации
  * `ρ < n` — разреженные данные, требуется осторожная инициализация
  
- **Интенсивность барьеров:** `β = max(B_j) / avg(σ_i)`
  * `β < 10` — слабые барьеры, МНК-инициализация безопасна
  * `β > 100` — сильные барьеры, требуется коррекция от запрещённых областей
  
- **Степень полинома:** `n`
  * `n ≤ 10` — низкая размерность, допустимы более агрессивные стратегии
  * `n > 20` — высокая размерность, требуется стабилизация через регуляризацию на этапе инициализации

### Шаг 4.2.2: Реализация базовой МНК-инициализации (основной метод)

**Этап 2.1: Построение взвешенной регрессионной задачи:**
1. **Формирование системы нормальных уравнений:**
   - Для полинома степени `n` без учёта интерполяционных ограничений:
     ```
     A·a = b, где:
       A_{kl} = Σ_i (x_i^{k+l} / σ_i)      // матрица Грама размером (n+1)×(n+1)
       b_k    = Σ_i (f(x_i)·x_i^k / σ_i)   // вектор правой части размером (n+1)
     ```
   - Индексы `k, l` пробегают значения `0..n` (степени мономов)

2. **Численное решение системы:**
   - Предпочтительный метод: **разложение Холецкого** для симметричной положительно определённой матрицы `A`
     * Преимущество: в 2 раза быстрее LU-разложения, численно устойчиво для хорошо обусловленных систем
   - Альтернатива при плохой обусловленности (`cond(A) > 1e12`):
     * **SVD-разложение** с отсечением малых сингулярных значений (`σ_k < 1e-10·σ_max`)
     * **Регуляризованный МНК (Тихонов):** добавить к диагонали `A` малую константу `λ·I`, где `λ = 1e-6·trace(A)/(n+1)`

3. **Получение коэффициентов исходного полинома:**
   - Результат решения: вектор `a_mnk = [a_0, a_1, ..., a_n]^T`
   - Проверка корректности: вычислить остатки `r_i = f(x_i) - F_mnk(x_i)` и убедиться в отсутствии `NaN/Inf`

**Этап 2.2: Проекция на подпространство с интерполяционными ограничениями:**
1. **Преобразование коэффициентов в параметризацию `F(x) = P_int(x) + Q(x)·W(x)`:**
   - Вычислить разность между МНК-полиномом и интерполяционным базисом:
     ```
     Δ(x) = F_mnk(x) - P_int(x)
     ```
   - Разделить разность на весовой множитель для получения корректирующего полинома:
     ```
     Q_initial(x) = Δ(x) / W(x)
     ```
   - Практическая реализация через решение системы линейных уравнений:
     * Выбрать `n - m + 1` контрольных точек `ξ_k ∈ [a, b]`, не совпадающих с узлами интерполяции
     * Сформировать систему: `Σ_{l=0}^{n-m} q_l · ξ_k^l · W(ξ_k) = Δ(ξ_k)`
     * Решить относительно коэффициентов `q_l` методом наименьших квадратов

2. **Верификация проекции:**
   - Проверить выполнение интерполяционных условий: `|F_initial(z_e) - f(z_e)| < 1e-10`
   - При нарушении применить итеративную коррекцию:
     ```
     для итерации = 1..5:
         ошибка_e = f(z_e) - F_current(z_e)
         если max|ошибка_e| < 1e-12: прервать
         скорректировать коэффициенты для устранения ошибки
     ```

### Шаг 4.2.3: Коррекция инициализации для избежания барьерных областей

**Этап 3.1: Диагностика близости к запрещённым точкам:**
1. **Вычисление расстояний до барьеров:**
   - Для каждой отталкивающей точки `(y_j, y_j^*)`:
     ```
     dist_j = |y_j^* - F_initial(y_j)|
     safety_ratio_j = dist_j / ε_safe, где ε_safe = 1e-8
     ```
   - Классификация точек:
     * `safety_ratio_j < 1` — критическая зона (полином пересекает барьер)
     * `1 ≤ safety_ratio_j < 10` — опасная зона (слишком близко к барьеру)
     * `safety_ratio_j ≥ 10` — безопасная зона

2. **Оценка риска «барьерного коллапса»:**
   - Если хотя бы одна точка в критической зоне → требуется обязательная коррекция
   - Если более 30% точек в опасной зоне → рекомендуется коррекция даже при отсутствии критических точек

**Этап 3.2: Алгоритмы коррекции в зависимости от степени риска:**

*Сценарий A: Критическая ситуация (пересечение барьера)*
1. **Локальная коррекция через градиентный подъём:**
   - Вычислить антиградиент отталкивающего члена в текущей точке:
     ```
     ∇J_repulse = +2 · Σ_j [B_j / |y_j^* - F(y_j)|³] · sign(y_j^* - F(y_j)) · [φ_k(y_j)·W(y_j)]
     ```
   - Выполнить один шаг в направлении антиградиента с малым шагом `α = 0.1`:
     ```
     q_corrected = q_initial + α · ∇J_repulse / ||∇J_repulse||
     ```
   - Повторять до выхода из критической зоны (максимум 10 итераций)

2. **Глобальная коррекция через модификацию базисного полинома:**
   - Если локальная коррекция не помогает (осцилляции), применить конструктивный метод:
     * Для каждой критической точки добавить «отталкивающий» член к базисному полиному:
       ```
       P_int_corrected(x) = P_int(x) + Σ_{j∈critical} C_j · (x - y_j) · exp(-λ·(x - y_j)²)
       ```
     * Коэффициенты `C_j` подбираются для обеспечения минимального расстояния `dist_j ≥ 5·ε_safe`
     * После коррекции повторно выполнить проекцию на подпространство `Q(x)·W(x)`

*Сценарий B: Опасная ситуация (близость к барьеру)*
1. **Превентивная коррекция через смещение:**
   - Вычислить вектор смещения, направленный от ближайших барьеров:
     ```
     shift_direction = Σ_j [sign(y_j^* - F(y_j)) · w_j · φ_k(y_j)·W(y_j)]
     где w_j = exp(-1.0 / safety_ratio_j)  // вес убывает с расстоянием до барьера
     ```
   - Применить смещение с амплитудой, пропорциональной степени риска:
     ```
     α_risk = 0.5 · (1.0 - min(safety_ratio_j) / 10.0)
     q_corrected = q_initial + α_risk · shift_direction / ||shift_direction||
     ```

### Шаг 4.2.4: Альтернативные стратегии инициализации для специальных случаев

**Стратегия «нулевой коррекции» (консервативный подход):**
- Установить все свободные коэффициенты в ноль: `q_k = 0`
- Результат: `F(x) = P_int(x)` — чистая интерполяция без аппроксимации данных
- Применение:
  * Когда отсутствуют аппроксимирующие точки (`N_approx = 0`)
  * Когда барьеры чрезвычайно сильные (`β > 1000`) и риск коллапса высок
  * Как резервный метод при неудачной МНК-инициализации

**Стратегия «случайной инициализации» (исследование пространства):**
1. **Генерация распределения для коэффициентов:**
   - Оценить характерный масштаб данных:
     ```
     scale_y = max|f(x_i)| - min|f(x_i)|
     scale_x = (b - a)
     ```
   - Установить дисперсию для нормального распределения:
     ```
     σ_q = 0.1 · scale_y / scale_x^{n-m}  // учитывает степень полинома коррекции
     ```

2. **Генерация ансамбля начальных точек:**
   - Создать `N_starts = min(5, n_free + 1)` различных начальных приближений
   - Для каждой точки `s`:
     ```
     q_k^{(s)} = q_k^{base} + δ_k^{(s)}, где δ_k^{(s)} ~ N(0, σ_q)
     ```
   - Применить коррекцию барьеров (шаг 4.2.3) к каждой точке ансамбля

3. **Отбор наиболее перспективных точек:**
   - Вычислить функционал `J` для каждой точки ансамбля
   - Отсортировать по возрастанию `J`
   - Выбрать топ-3 точки для многократного запуска оптимизатора (шаг 4.1.6)

**Стратегия «иерархической инициализации» (для высоких степеней):**
- Применяется при `n > 15` для избежания осцилляций Рунге
- Алгоритм:
  1. Начать с полинома низкой степени `n_start = min(5, n)`
  2. Выполнить полную оптимизацию для степени `n_start`
  3. Увеличить степень на 2: `n_current += 2`
  4. Инициализировать новые коэффициенты нулями, сохранить старые коэффициенты
  5. Повторять шаги 2–4 до достижения целевой степени `n`
- Преимущество: постепенное уточнение решения, избежание плохих локальных минимумов

### Шаг 4.2.5: Адаптивный выбор стратегии инициализации

**Дерево принятия решений:**

```
НАЧАЛО
│
├─ Если N_approx = 0 → Стратегия «нулевой коррекции»
│
├─ Если β > 1000 → 
│   ├─ Попробовать МНК-инициализацию с коррекцией
│   └─ При неудаче → Стратегия «нулевой коррекции»
│
├─ Если ρ < 0.5·n → 
│   ├─ Применить регуляризованный МНК (λ = 1e-4·trace(A)/(n+1))
│   └─ Добавить случайное возмущение (σ = 0.05·||q_mnk||)
│
├─ Если β > 100 ИЛИ (более 30% точек в опасной зоне) →
│   ├─ МНК-инициализация + агрессивная коррекция барьеров
│   └─ Сгенерировать 2 дополнительные точки через случайную инициализацию
│
└─ Иначе (стандартный случай) →
    └─ Чистая МНК-инициализация с лёгкой коррекцией (только для критических точек)
```

**Метрики качества инициализации (для диагностики):**
- `J_initial / J_random` — отношение функционала к случайному решению (цель: < 0.5)
- `min_dist_to_barrier / ε_safe` — минимальное расстояние до барьеров (цель: > 10)
- `||residuals||_RMS / std(f)` — нормированный остаток аппроксимации (цель: < 1.0)

### Шаг 4.2.6: Валидация и постобработка инициализированного решения

**Комплексная проверка корректности:**
1. **Численная корректность:**
   - Отсутствие `NaN/Inf` в коэффициентах и значениях полинома
   - Ограниченность коэффициентов: `|q_k| < 1e10` (защита от переполнения)

2. **Выполнение ограничений:**
   - Интерполяция: `|F(z_e) - f(z_e)| < 1e-10` для всех узлов
   - Безопасность барьеров: `|F(y_j) - y_j^*| > ε_safe` для всех отталкивающих точек

3. **Физическая правдоподобность:**
   - Отсутствие экстремальных осцилляций: `max|F(x)| < 10·max|f(x_i)|` на `[a, b]`
   - Плавность: `||F''||_L2 < 100·max|f(x_i)| / (b - a)²`

**Автоматическая коррекция при нарушении условий:**
- При нарушении интерполяции → применить проекционный шаг (шаг 4.2.2, этап 2.2)
- При нарушении безопасности барьеров → применить коррекцию (шаг 4.2.3)
- При экстремальных осцилляциях → уменьшить коэффициенты пропорционально: `q_k ← 0.5·q_k` и повторить проверку

**Генерация диагностического отчёта об инициализации:**
```
Инициализация параметров оптимизации:
  Стратегия: МНК + коррекция барьеров
  Исходные коэффициенты: [q_0=1.23, q_1=-0.45, ..., q_7=0.02]
  
  Качество инициализации:
    • Функционал J = 23.456 (улучшение на 78% от случайного)
    • Мин. расстояние до барьеров: 0.156 (> 1e-8, БЕЗОПАСНО)
    • Точность интерполяции: 2.3e-14 (ТОЧНО)
    • Норма коэффициентов: 1.87 (в допустимых пределах)
  
  Рекомендации:
    • Стартовая точка пригодна для оптимизации
    • Рекомендуемый начальный шаг: α = 0.5
```

Этот план обеспечивает надёжную, адаптивную и диагностируемую инициализацию параметров оптимизатора, учитывающую специфику задачи смешанной аппроксимации с барьерными условиями и интерполяционными ограничениями. Подход сочетает теоретически обоснованный МНК-метод с практическими стратегиями защиты от численных аномалий и обеспечивает высокую вероятность сходимости к качественному решению.