## Подшаг 6.2: Анализ чувствительности решения — подробный план реализации на C++

### Шаг 6.2.1: Теоретическая основа анализа чувствительности в задаче смешанной аппроксимации

**Цели анализа чувствительности:**
- Оценить устойчивость полученного решения к вариациям входных параметров и данных
- Выявить критически важные параметры, требующие точной настройки
- Определить допустимые диапазоны изменения параметров без деградации качества решения
- Предоставить пользователю количественные рекомендации по настройке весов и регуляризации

**Типы чувствительности для анализа:**
- **Параметрическая чувствительность:** реакция решения на изменения весов `σ_i`, `B_j` и регуляризации `γ`
- **Данные-ориентированная чувствительность:** реакция на возмущения координат и значений точек данных
- **Структурная чувствительность:** реакция на изменение топологии точек (добавление/удаление точек определённого типа)

### Шаг 6.2.2: Реализация параметрического анализа чувствительности

**Этап 2.1: Анализ чувствительности к параметру регуляризации `γ`**

1. **Построение траектории решений по γ:**
   - Определить логарифмическую сетку значений вокруг текущего `γ_current`:
     ```
     γ_values = [γ_current · 10^k] для k = -2, -1.5, -1, -0.5, 0, +0.5, +1, +1.5, +2
     с ограничениями: γ_min = 1e-8, γ_max = 1e4 · γ_current
     ```
   - Для каждого значения `γ_k` выполнить оптимизацию с фиксированными весами `σ_i`, `B_j` и начальным приближением из предыдущего решения (для ускорения сходимости)

2. **Вычисление метрик качества для каждой точки траектории:**
   - Аппроксимационная ошибка: `E_approx(γ_k) = RMS(f(x_i) - F_γk(x_i))`
   - Норма кривизны: `C(γ_k) = sqrt(∫[F_γk''(x)]²dx)`
   - Расстояние до барьеров: `D_min(γ_k) = min_j |F_γk(y_j) - y_j^*|`
   - Значение функционала: `J_total(γ_k)`

3. **Определение оптимального диапазона γ:**
   - Найти точку «локтя» на кривой `E_approx(γ)` vs `C(γ)` (компромисс точность/гладкость)
   - Определить безопасный диапазон: `[γ_safe_min, γ_safe_max]`, где:
     * `D_min(γ) > 2·ε_safe` для всех γ в диапазоне
     * `E_approx(γ) < 1.2 · E_approx(γ_optimal)`
   - Вычислить коэффициент чувствительности:
     ```
     S_γ = |d log(E_approx) / d log(γ)| в окрестности γ_current
     ```
     * `S_γ < 0.2` — низкая чувствительность (устойчивое решение)
     * `0.2 ≤ S_γ < 1.0` — умеренная чувствительность
     * `S_γ ≥ 1.0` — высокая чувствительность (требует точной настройки γ)

**Этап 2.2: Анализ чувствительности к весам отталкивания `B_j`**

1. **Индивидуальный анализ для каждой отталкивающей точки:**
   - Для каждой точки `j` построить локальную траекторию:
     ```
     B_j_variants = [B_j_current · α] для α = 0.1, 0.3, 1.0, 3.0, 10.0
     остальные B_k (k≠j) фиксированы на текущих значениях
     ```
   - Для каждого варианта выполнить локальную оптимизацию (10–20 итераций достаточно для оценки тренда)

2. **Метрики локальной чувствительности:**
   - Изменение расстояния до барьера `j`: `ΔD_j = |D_j(B_j_var) - D_j(B_j_current)|`
   - Изменение глобальной ошибки аппроксимации: `ΔE = |E_approx(B_j_var) - E_approx(B_j_current)|`
   - Коэффициент передачи влияния:
     ```
     T_j = ΔE / (ΔD_j + ε)  // насколько изменение барьера влияет на аппроксимацию
     ```

3. **Классификация барьеров по критичности:**
   - **Критический барьер:** `T_j > 0.5` и `ΔD_j < 0.1·D_j_current` при изменении `B_j` в 10 раз
     * Требует точной настройки веса
     * Малые изменения `B_j` приводят к резким изменениям формы полинома
   - **Умеренный барьер:** `0.1 < T_j ≤ 0.5`
   - **Некритичный барьер:** `T_j ≤ 0.1` или `ΔD_j > 0.5·D_j_current`
     * Допускает широкий диапазон весов без деградации решения

**Этап 2.3: Анализ чувствительности к весам аппроксимации `σ_i`**

1. **Групповой анализ по кластерам точек:**
   - Разделить аппроксимирующие точки на кластеры по близости координат (например, методом DBSCAN)
   - Для каждого кластера `C_l` выполнить вариацию весов:
     ```
     σ_i_var = σ_i_current · β для всех i ∈ C_l
     β = 0.3, 1.0, 3.0
     ```

2. **Метрики влияния кластеров:**
   - Локальная ошибка в кластере: `E_l = RMS_{i∈C_l}(f(x_i) - F(x_i))`
   - Глобальное искажение формы: `ΔF_global = max_x |F_var(x) - F_current(x)|`
   - Коэффициент локальности влияния:
     ```
     L_l = (E_l_var - E_l_current) / (ΔF_global + ε)
     ```
     * `L_l ≈ 1.0` — локальное влияние (изменение весов влияет только на близкие области)
     * `L_l << 1.0` — глобальное влияние (изменение локальных весов искажает всю функцию)

### Шаг 6.2.3: Реализация анализа чувствительности к возмущениям данных

**Этап 3.1: Стохастический анализ устойчивости**

1. **Генерация ансамбля возмущённых наборов данных:**
   - Создать `M = 50` возмущённых копий исходных данных:
     ```
     для копии m = 1..M:
         для каждой аппроксимирующей точки i:
             x_i^{(m)} = x_i + δ_x · randn() · local_spacing(x_i)
             f_i^{(m)} = f_i + δ_y · randn() · σ_i
         где:
             δ_x = 0.01  // 1% от локального расстояния между точками
             δ_y = 0.05  // 5% от характерного масштаба шума
             local_spacing(x) = медианное расстояние до 3 ближайших соседей
     ```

2. **Оценка вариации решения:**
   - Для каждой копии выполнить полную оптимизацию (с ускорением через тёплый старт от исходного решения)
   - На равномерной сетке из `P = 200` точек на `[a, b]` вычислить:
     ```
     μ_F(p) = среднее(F^{(m)}(ξ_p)) по m=1..M
     σ_F(p) = стандартное отклонение(F^{(m)}(ξ_p)) по m=1..M
     ```

3. **Метрики глобальной устойчивости:**
   - Коэффициент вариации формы:
     ```
     CV_shape = max_p(σ_F(p)) / (max_p|μ_F(p)| + ε)
     ```
   - Пространственная локализация неустойчивости:
     * Найти интервалы, где `σ_F(p) > 2·median(σ_F)`
     * Связать с близостью к барьерам или разреженностью данных
   - Интерпретация:
     * `CV_shape < 0.02` — высокая устойчивость
     * `0.02 ≤ CV_shape < 0.1` — умеренная устойчивость
     * `CV_shape ≥ 0.1` — низкая устойчивость, решение чувствительно к шуму

**Этап 3.2: Детерминированный анализ худших случаев**

1. **Поиск критических возмущений методом градиентного подъёма:**
   - Целевая функция для поиска худшего случая:
     ```
     W(Δx, Δf) = |F_{perturbed}(x_test) - F_original(x_test)|
     где x_test — точка максимальной вариации из стохастического анализа
     ```
   - Оптимизировать возмущения `(Δx_i, Δf_i)` в допустимых пределах:
     ```
     |Δx_i| ≤ δ_x_max · local_spacing(x_i)
     |Δf_i| ≤ δ_y_max · σ_i
     ```
   - Использовать градиентный метод для максимизации `W` (обратная задача к основной оптимизации)

2. **Оценка запаса устойчивости:**
   - Отношение допустимого возмущения к критическому:
     ```
     margin_x = δ_x_max / ||Δx_critical||
     margin_y = δ_y_max / ||Δf_critical||
     ```
   - Интерпретация:
     * `margin > 5` — большой запас устойчивости
     * `2 < margin ≤ 5` — достаточный запас
     * `margin ≤ 2` — малый запас, решение уязвимо к реальным возмущениям данных

### Шаг 6.2.4: Матрица взаимной чувствительности параметров

**Построение матрицы частных производных:**

1. **Численное дифференцирование по параметрам:**
   - Для каждой пары параметров `(θ_p, θ_q)` где `θ = {γ, B_1..B_m, σ_1..σ_n}`:
     ```
     ∂J/∂θ_p ≈ (J(θ_p + h_p) - J(θ_p - h_p)) / (2·h_p)
     ∂²J/∂θ_p∂θ_q ≈ [J(θ_p+h_p, θ_q+h_q) - J(θ_p+h_p, θ_q-h_q) 
                    - J(θ_p-h_p, θ_q+h_q) + J(θ_p-h_p, θ_q-h_q)] / (4·h_p·h_q)
     ```
   - Шаги дифференцирования: `h_γ = 0.1·γ`, `h_B = 0.1·B_j`, `h_σ = 0.1·σ_i`

2. **Нормировка и интерпретация матрицы Гессе:**
   - Построить нормированную матрицу корреляции чувствительности:
     ```
     C_{pq} = (∂²J/∂θ_p∂θ_q) / sqrt(|∂²J/∂θ_p²| · |∂²J/∂θ_q²|)
     ```
   - Анализ структуры матрицы:
     * Диагональные элементы `|C_{pp}| ≈ 1` — параметр сильно влияет на функционал
     * Недиагональные элементы `|C_{pq}| > 0.7` — сильная взаимосвязь параметров (компенсация)
     * Блочная структура — группы параметров, действующих совместно

3. **Выявление компенсирующих пар:**
   - Пример: увеличение `γ` может компенсироваться уменьшением `B_j` для сохранения баланса гладкость/барьер
   - Количественная оценка компенсации:
     ```
     компенсация_{γ,Bj} = |C_{γ,Bj}| / (|C_{γ,γ}| · |C_{Bj,Bj}|)
     ```
   - При `компенсация > 0.5` рекомендовать совместную настройку параметров

### Шаг 6.2.5: Адаптивная стратегия рекомендаций по настройке параметров

**Генерация персонализированных рекомендаций:**

1. **Классификация проблемы на основе анализа чувствительности:**
   ```
   ЕСЛИ (S_γ > 1.0) И (γ_current < γ_optimal):
       проблема = "НЕДОСТАТОЧНАЯ РЕГУЛЯРИЗАЦИЯ"
       рекомендация = "Увеличить γ в 2–3 раза для стабилизации решения"
       
   ЕСЛИ (существует критический барьер j) И (D_j < 5·ε_safe):
       проблема = "ИЗБЫТОЧНО СИЛЬНЫЙ БАРЬЕР"
       рекомендация = "Уменьшить B_j в 5–10 раз для улучшения баланса с аппроксимацией"
       
   ЕСЛИ (CV_shape > 0.1) И (локальные кластеры с L_l << 0.1):
       проблема = "ГЛОБАЛЬНАЯ НЕУСТОЙЧИВОСТЬ"
       рекомендация = "Увеличить γ и/или уменьшить степень полинома"
   ```

2. **Количественные рекомендации с диапазонами:**
   - Для каждого параметра указать:
     * Текущее значение
     * Рекомендуемый диапазон: `[θ_min, θ_max]`
     * Оптимальное значение (если определено): `θ_opt`
     * Чувствительность в рекомендуемом диапазоне: низкая/умеренная/высокая
   - Пример:
     ```
     Параметр γ:
       Текущее: 0.15
       Рекомендуемый диапазон: [0.3, 1.2]
       Оптимум: 0.65
       Чувствительность: умеренная (изменение на 50% меняет ошибку на <10%)
     ```

3. **Приоритизация рекомендаций:**
   - Ранжирование по потенциальному улучшению качества:
     ```
     приоритет = (потенциальное_улучшение_E_approx) × (1.0 / чувствительность)
     ```
   - Вывод топ-3 рекомендаций в порядке убывания приоритета

### Шаг 6.2.6: Оптимизация вычислительной эффективности анализа

**Стратегии ускорения:**

1. **Иерархическая схема анализа:**
   - Уровень 1 (быстрый скрининг): грубая оценка чувствительности через 3–5 точек траектории
   - Уровень 2 (детальный анализ): полная траектория только для параметров с высокой чувствительностью на уровне 1
   - Экономия: 70–90% вычислительных затрат при сохранении точности для критических параметров

2. **Кэширование промежуточных решений:**
   - Хранить решения для близких значений параметров в структуре `SolutionCache`
   - При запросе решения для `γ_new` использовать ближайшее закэшированное решение как начальное приближение
   - Стратегия инвалидации: удалять решения старше 5 минут или при изменении топологии данных

3. **Параллельное выполнение независимых траекторий:**
   - Анализ чувствительности по разным параметрам полностью независим
   - Распределить вычисления по ядрам CPU через пул потоков:
     ```
     для каждого параметра θ_p:
         запустить поток для построения траектории по θ_p
     собрать результаты после завершения всех потоков
     ```
   - Ускорение: линейное до числа физических ядер

### Шаг 6.2.7: Формирование диагностического отчёта об анализе чувствительности

**Структура отчёта:**

```
АНАЛИЗ ЧУВСТВИТЕЛЬНОСТИ РЕШЕНИЯ
Дата: 2026-02-08 14:30:22
Исходное решение: итерация 87, J = 5.1942

1. ПАРАМЕТРИЧЕСКАЯ ЧУВСТВИТЕЛЬНОСТЬ
   ┌──────────────────┬──────────┬──────────────┬──────────────┐
   │ Параметр         │ Текущее  │ Реком. диап. │ Чувствит.    │
   ├──────────────────┼──────────┼──────────────┼──────────────┤
   │ γ (регуляризация)│ 0.15     │ [0.3, 1.2]   │ УМЕРЕННАЯ ★★☆│
   │ B_3 (барьер)     │ 1000     │ [100, 300]   │ ВЫСОКАЯ ★★★  │
   │ B_7 (барьер)     │ 50       │ [30, 200]    │ НИЗКАЯ ★☆☆   │
   └──────────────────┴──────────┴──────────────┴──────────────┘

2. КРИТИЧЕСКИЕ БАРЬЕРЫ
   • Барьер #3 (y=3.789): КРИТИЧЕСКИЙ
     - Текущее расстояние: 0.123
     - Изменение расстояния при ±10× веса: < 5%
     - Рекомендация: УМЕНЬШИТЬ B_3 до 200 для улучшения баланса
   
   • Барьер #7 (y=5.214): НЕКРИТИЧНЫЙ
     - Текущее расстояние: 0.876
     - Изменение расстояния при ±10× веса: > 50%
     - Рекомендация: вес может варьироваться в широких пределах

3. УСТОЙЧИВОСТЬ К ВОЗМУЩЕНИЯМ ДАННЫХ
   • Коэффициент вариации формы: CV = 0.043 (УМЕРЕННАЯ устойчивость)
   • Критические области неустойчивости:
     - Интервал [2.1, 2.8]: σ_F/μ_F = 0.12 (связано с близостью к барьеру #3)
   • Запас устойчивости к худшим возмущениям: 3.2× (ДОСТАТОЧНЫЙ)

4. ВЗАИМОСВЯЗИ ПАРАМЕТРОВ
   • Сильная компенсация (|C| > 0.7):
     - γ ↔ B_3: увеличение γ на 50% компенсируется уменьшением B_3 на 30%
   • Рекомендация: настраивать γ и B_3 совместно для сохранения баланса

5. ПРИОРИТЕТНЫЕ РЕКОМЕНДАЦИИ
   1. [ВЫСОКИЙ ПРИОРИТЕТ] Уменьшить B_3 с 1000 до 200
      Ожидаемое улучшение: снижение ошибки аппроксимации на 18%
      
   2. [СРЕДНИЙ ПРИОРИТЕТ] Увеличить γ с 0.15 до 0.6
      Ожидаемое улучшение: повышение устойчивости без заметного роста ошибки
      
   3. [НИЗКИЙ ПРИОРИТЕТ] Проверить точность данных в интервале [2.1, 2.8]
      Обоснование: область повышенной чувствительности к шуму

ИТОГОВАЯ ОЦЕНКА УСТОЙЧИВОСТИ: 72/100 (УДОВЛЕТВОРИТЕЛЬНО)
Решение приемлемо для использования, но рекомендуется применить рекомендации #1 и #2.
```

Этот план обеспечивает комплексный, количественный и практически ориентированный анализ чувствительности решения метода смешанной аппроксимации. Подход сочетает стохастические и детерминированные методы оценки устойчивости, выявляет критические параметры и взаимосвязи между ними, и предоставляет пользователю конкретные, измеримые рекомендации по улучшению качества и надёжности решения. Реализация оптимизирована для вычислительной эффективности через иерархическую схему анализа и параллельные вычисления.