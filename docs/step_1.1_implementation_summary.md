# Реализация шага 1.1: Валидация входных данных

## Обзор

Реализована комплексная система валидации входных данных для метода смешанной аппроксимации в соответствии с детальным планом из [`docs/1.1.md`](1.1.md).

## Основные изменения

### 1. Новые структуры данных ([`include/mixed_approximation/validator.h`](include/mixed_approximation/validator.h))

- **`ValidationLevel`** (enum): `Error`, `Warning` - уровни серьёзности проблем
- **`ValidationIssue`** (struct): описание проблемы с уровнем, сообщением и рекомендацией
- **`ValidationReport`** (struct): детальный отчёт валидации, содержащий:
  - Списки ошибок и предупреждений
  - Сводную статистику (количество точек, веса, степень полинома, свободные параметры)
  - Метод `format()` для форматированного вывода отчёта

### 2. Новые методы валидации ([`src/validator.cpp`](src/validator.cpp))

#### 1.1.2: Проверка интервала `[a, b]`
- **`check_interval()`**: 
  - Проверяет конечность `a` и `b` с помощью `std::isfinite()`
  - Адаптивная погрешность: `ε_interval = 1e-12 * max(|a|, |b|, 1.0)`
  - Условие: `b - a > ε_interval`

#### 1.1.3: Проверка принадлежности точек интервалу
- **`check_points_in_interval()`**:
  - Адаптивная погрешность: `ε_point = 1e-9 * (b - a)`
  - Проверяет все точки (аппроксимирующие, отталкивающие, интерполяционные)
  - Проверка на конечность координат
  - Примечание: фактическое "притягивание" точек к границам вынесено в предобработку данных

#### 1.1.4: Проверка непересечения множеств (оптимизированная)
- **`check_disjoint_sets()`**:
  - Сложность O(N log N) за счёт сортировки объединённого массива точек
  - Адаптивный порог: `ε_overlap = max(1e-12, 1e-9 * max(|x_i|, |y_j|, 1.0))`
  - Классификация конфликтов:
    - **Фатальные** (ошибки): пересечение интерполяционных узлов с аппроксимирующими или отталкивающими точками
    - **Предупреждения**: пересечение аппроксимирующих и отталкивающих точек

#### 1.1.5: Валидация весовых коэффициентов
- **`check_positive_weights()`**:
  - Строгая положительность: `σ_i > 1e-15`, `B_j > 1e-15`, `γ ≥ 0`
  - Проверка на конечность всех весов
  - Предупреждения:
    - Отношение `max(σ_i) / min(σ_i) >= 1e12` (численная неустойчивость)
    - `B_j > 1e8` (слишком жёсткий барьер)
    - `B_j < 1e-6` (неэффективное отталкивание)
    - `γ = 0` (риск осцилляций)
    - `γ > 1e6` (чрезмерное сглаживание)

#### 1.1.6: Проверка соотношения степени полинома и интерполяционных узлов
- **`check_interpolation_nodes_count()`**:
  - Условие: `m ≤ n + 1` (ошибка при нарушении)
  - Предупреждение при `m == n + 1` (полином полностью определён интерполяцией)

#### 1.1.8: Проверка пустых множеств
- **`check_nonempty_sets()`**:
  - Хотя бы одно из множеств (аппроксимирующие точки или интерполяционные узлы) должно быть непустым

#### 1.1.8: Проверка численных аномалий
- **`check_numerical_anomalies()`**:
  - Предупреждения о:
    - Экстремальном разбросе весов
    - Очень больших/малых весах отталкивания
    - Нулевой или очень большой `γ`
    - Слишком маленьком или большом размере интервала

### 3. Основной интерфейс

#### `validate(const ApproximationConfig& config, bool strict_mode = false)`
Упрощённый интерфейс, возвращающий строку с ошибками. В `strict_mode` предупреждения трактуются как ошибки.

#### `validate_full(const ApproximationConfig& config, bool strict_mode = false)`
Возвращает детальный `ValidationReport` с полной информацией.

## Тестирование

### Существующие тесты
- [`tests/test_basic.cpp`](tests/test_basic.cpp): базовые тесты валидатора (проходят)

### Новые тесты
- [`tests/test_validator_advanced.cpp`](tests/test_validator_advanced.cpp): расширенные тесты, покрывающие все новые проверки:
  - Валидация интервала (конечность, порядок, NaN/Inf)
  - Принадлежность точек интервалу (включая нечисловые координаты)
  - Непересечение множеств (фатальные конфликты и предупреждения)
  - Положительность весов и параметров
  - Количество интерполяционных узлов (ошибки и предупреждения)
  - Уникальность интерполяционных узлов
  - Пустые множества
  - Численные аномалии
  - Работа `validate_full()` и `validate()`
  - Режим строгой валидации

Все тесты проходят успешно.

## Обратная совместимость

- Старый интерфейс `Validator::validate(const ApproximationConfig&)` сохранён (без `strict_mode` по умолчанию)
- Все новые методы являются статическими, как и ранее
- Сигнатуры существующих проверок сохранены

## Соответствие плану шага 1.1

| Пункт плана | Статус | Примечания |
|-------------|--------|------------|
| 1.1.1 Структуры данных | ✅ | WeightedPoint, InterpolationNode, ApproximationConfig |
| 1.1.2 Проверка интервала | ✅ | isfinite + адаптивный ε_interval |
| 1.1.3 Принадлежность точек | ✅ | Адаптивный ε_point, проверка конечности |
| 1.1.4 Непересечение множеств | ✅ | O(N log N), адаптивный ε_overlap, классификация |
| 1.1.5 Валидация весов | ✅ | Положительность, диапазоны, предупреждения |
| 1.1.6 Соотношение m и n | ✅ | m ≤ n+1 + предупреждение при m == n+1 |
| 1.1.7 Отчёт о валидации | ✅ | ValidationReport со статистикой, разделение ошибок/предупреждений |
| 1.1.8 Крайние случаи | ✅ | Пустые множества, численные аномалии |

**Примечание**: "Притягивание" точек к границам (1.1.3) не реализовано в валидаторе, так как валидатор не должен модифицировать входные данные. Эта логика должна быть вынесена в предобработчик данных (например, в `MixedApproximation::prepare()` или `ConfigReader`).

## Дальнейшие улучшения (вне шага 1.1)

- Реализовать фактическое "притягивание" точек к границам в предобработке
- Добавить возможность настройки порогов (ε_interval, ε_point, ε_overlap) через `ApproximationConfig`
- Валидация дополнительных параметров (например, проверка корректности файлов данных в `ConfigReader`)
